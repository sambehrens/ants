<html>
<head>
	<title>SparDrawersEpilepticDrools</title>
	<link rel="stylesheet" href="css/style.css">
    <link href='https://fonts.googleapis.com/css?family=Orbitron:400,900' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Bree+Serif' rel='stylesheet' type='text/css'>
    <link href='https://fonts.googleapis.com/css?family=Muli:400,300' rel='stylesheet' type='text/css'>
</head>
<body background="images/background.png">
    <div id="menu">
        <ul id="wrapper">
            <li>
                <input id="enterName" type="text" value="" title="Come on, be creative" placeHolder="Nick" maxlength="15" spellcheck="false">
            </li>
            <li>
                <input id="enterNumPlayers" type="text" value="" placeHolder="Number of players" maxlength="1">
            </li>
            <li>
                <select id="player"></select>
            </li>
            <li>
                <select id="biome">
                    <option>Forest</option>
                    <option>Desert</option>
                    <option>Mountain</option>
                </select>
            </li>
            <li>
                <button id="proceed">Next</button>
            </li>
        </ul>
    </div>
    <canvas id="myCanvas" resize></canvas>
    <button id="aCard">
        <p>Add card</p>
    </button>
    <div id="bBar">
        <div class="deck"></div>
        <ul id="cards">
        </ul>
    </div>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
    <script type="text/javascript" src="js/paper-full.js"></script>
    <script type="text/paperscript" canvas="myCanvas">

/*
to do:
3. figure out what the hell to do with attacks
*/

var expanded = false; // Is the bottom bar expanded?
var numCards = 0; // number of cards
var bBarWidth = 0;// width of bottom bar for cards

$("#cards").hide();
$('#bBar').hide();
$("#aCard").hide();

function  expandBBar() {// expand the card shelf a.k.a. bottom bar

    for (var i = 0; i < players[currentPlayer].cards.length; i += 1) {
        $("#cards").append('<li class="card">This is Card <p>Attack: ' + players[currentPlayer].cards[i].attack + '</p> <p>Defense: ' + players[currentPlayer].cards[i].defend + '</p> </li>');
    }


    $("#bBar").css("background", "black");
    $("#bBar").css("width", "100%");
    $("#cards").delay(680).show(680);
    
    if (numCards >= 4) {
        $("#bBar").css("overflowX", "scroll");
    }
    expanded = true;
}

function hideBBar() { // hide the card cabinet a.k.a. bottom bar
    if (expanded === true) {
        $("#cards").delay(600).show(600).finish();
        $("#bBar").css("background", "AntiqueWhite");
        $("#bBar").css("width", "20vw");
        $("#cards").hide(0);
        $("#bBar").css("overflowX", "hidden");
        $(".card").remove();
        expanded = false;
    }
}

$('#bBar').click(function () {
    "use strict";
    if (expanded === false) {

        expandBBar();

    } else {

        hideBBar();

    }
});

//var scrollW = document.getElementsByClassName("");
$("#aCard").click(function () {
    "use strict";
    if (numCards < 10 && actionCounter > 0 && turnCounter === 2) {
        numCards += 1;

        var randomCardIndex = Math.floor((Math.random() * (players[currentPlayer].character.cards.length -1)));
        
        //add a card li to the cards div
        $("#cards").append('<li class="card">This is Card <p>Attack: ' + players[currentPlayer].character.cards[randomCardIndex].attack + '</p> <p>Defense: ' + players[currentPlayer].character.cards[randomCardIndex].defend + '</p> </li>');

        
        //extend bar width
        bBarWidth += (28);
        $("#cards").css("width", bBarWidth + "vw");
        
        if (numCards >= 4) {
            $("#bBar").css("overflowX", "scroll");
        }

        players[currentPlayer].cards.push(players[currentPlayer].character.cards[randomCardIndex]);

        actionCounter -= 1;
    }
});
    
$("#myCanvas").hide();


var size, biome, playerType, numPlayers = 30, gameSetup = 1, players = [], move = false, currentPlayer = 0, turnCounter = 0, moveCounter = 0;

var playerTypes = [// array of player types: add new player types here
    {
        type: 'Greed',
        color: '#cc00cc',
        dice: 12,
        health: 20,
        numActions: 3,
        cards: [// array of cards: put new cards here
            {
                attack: 5,
                defend: 3,
                rarity: 1
            },
            {
                attack: 6,
                defend: 0,
                rarity: 2
            },
            {
                attack: 2,
                defend: 2,
                rarity: 2
            }
        ]
    },
    {
        type: 'Wrath',
        color: '#ff0000',
        dice: 4,
        health: 16,
        numActions: 2,
        cards: [// array of cards: put new cards here
            {
                attack: 3,
                defend: 5,
                rarity: 1
            },
            {
                attack: 6,
                defend: 0,
                rarity: 2
            }
        ]
    },
    {
        type: 'Pride',
        color: '#e5e600',
        dice: 8,
        health: 22,
        numActions: 2,
        cards: [// array of cards: put new cards here
            {
                attack: 3,
                defend: 5,
                rarity: 1
            },
            {
                attack: 6,
                defend: 0,
                rarity: 2
            }
        ],
        aimerLine: new Path()
    }
];


$("#player").hide();
$("#enterName").hide();

$("#proceed").click(function() {
    playerType = $("#player").val();
    biome = $("#biome").val();

    if (numPlayers === gameSetup) {
        $("#proceed").html('Start Game');
    }

    if (gameSetup === 1) {
        $("#enterNumPlayers").hide();
        $("#biome").hide();

        numPlayers = $("#enterNumPlayers").val();// taking in the number of players
        numPlayers = parseInt(numPlayers,10);
        size = 3 + (numPlayers * 2);//  scaling the size of map to the number of players

        $("#player").show();
        $("#enterName").show();
    }

    if (gameSetup > 1) {

        var xSpawn = 6, ySpawn = 6; //  coords where players spawn

        if (numPlayers === 2) {
            if (gameSetup === 2) {
                xSpawn = 4;
                ySpawn = 1;
            } else {
                xSpawn = 2;
                ySpawn = 5;
            }
        } else if (numPlayers === 3) {
            if (gameSetup === 2) {
                xSpawn = 4;
                ySpawn = 1;
            } else if (gameSetup === 3) {
                xSpawn = 7;
                ySpawn = 4;
            } else {
                xSpawn = 1;
                ySpawn = 7;
            }
        } else if (numPlayers === 4) {
            if (gameSetup === 2) {
                xSpawn = 5;
                ySpawn = 1;
            } else if (gameSetup === 3) {
                xSpawn = 9;
                ySpawn = 2;
            } else if (gameSetup === 4) {
                xSpawn = 1;
                ySpawn = 9;
            } else {
                xSpawn = 6;
                ySpawn = 8;
            }
        }

        player = {
            nick: $("#enterName").val(),
            character: playerTypes[$("#player option:selected").index()],
            coord: {
                x: xSpawn,//   x coord of where player spawns
                y: ySpawn //   y coord of where player spawns
            },
            path: new Path.RegularPolygon(new Point(0,0),0,0),
            cards: [],//    put cards that the player can gets in this array
            health: playerTypes[$("#player option:selected").index()].health,
            nameLabel: new PointText() //   name label
        };
        if (player.nick === '') {
            player.nick = 'Player ' + (gameSetup-1); // if no nickname is entered, they get assigne a player number
        }

        players.push(player);
    }


    if (numPlayers + 1 === gameSetup) {
        $("body").css('background-image', 'none');
        $("#menu").hide();
        $("#myCanvas").fadeToggle("slow");
        $('#bBar').show('slow');
        $("#aCard").show('slow');
        setup();
    }

    $("#enterName").val('');

    gameSetup += 1;
});



for (var i = 0; i < playerTypes.length; i += 1) {//   add player types to select option in html code
    $("#player").append("<option>" + playerTypes[i].type + "</option>");
}



var boardMain = [];


function setup() {//           setup map here, also draw it
    var x = 200,y = 100;
    var topLeft = -1;
    var bottomRight = -size;
    for (var i = 0; i < size; i += 1) {
        var row = [];
        topLeft++;
        bottomRight++;
        for (var ii = 0; ii < size; ii += 1) {

            var type = randomTileType();

            if (ii < ((size-1)/2)-topLeft && i < ((size-1)/2)){    //this removes the top left corner to make the board a hexagon
              
                var raster = new Raster({ // a raster is just an image and this is where the tile images are made ;)
                    position: new Point(20000,y),
                    source: imagePicker(type)
                })

                var circle = new Shape.Circle(new Point(20000,y), 60);//circle for in front of image
                circle.fillColor = new Color(0.5,0.5,05,0.3);
                circle.visible = false;
           
            } else if (ii > ((size - ((size-1)/2))-1)-bottomRight && i > ((size - ((size-1)/2))-1)){  //this removes the bottom right corner
               
                var raster = new Raster({ // a raster is just an image and this is where the tile images are made ;)
                    position: new Point(20000,y),
                    source: imagePicker(type)
                })

                var circle = new Shape.Circle(new Point(20000,y), 60);//circle for in front of image
                circle.fillColor = new Color(0.5,0.5,05,0.3);
                circle.visible = false;
            
            } else {
                var raster = new Raster({ // a raster is just an image and this is where the tile images are made ;)
                    position: new Point(x,y),
                    source: imagePicker(type)
                })

                var circle = new Shape.Circle(new Point(x,y), 60);//circle for in front of image
                circle.fillColor = new Color(0.5,0.5,05,0.3);
                circle.visible = false;
            }

            var hexObject = {
                x: x, // x coord in pixels
                y: y, // y coord in pixels
                radius: 50, // radius of tile, i need to remember why we need this
                type: type, // type of tile i.e. forest, mountain
                path: raster, // image
                backgroundPath: circle // circle for in front of image
            };

            row.push(hexObject);
            x += 110;
        }
        boardMain.push(row);
        y += 95;
        x = (200-5*(i+1)) + (i+1) * 60;
    }
    for (var i = 0; i < players.length; i += 1) {//  setup all of the images for the players including the nametag
        var xP = boardMain[players[i].coord.y][players[i].coord.x].path.position.x;
        var yP = boardMain[players[i].coord.y][players[i].coord.x].path.position.y;
        players[i].path = new Path.RegularPolygon(new Point(xP, yP), 3, 30);
        players[i].path.fillColor = players[i].character.color;
        players[i].nameLabel = new PointText({
            point: players[i].path.position,
            justification: 'center',
            fontSize: 30,
            fillColor: 'black',
            content: players[i].nick
        });
    }
    actionCounter = players[currentPlayer].character.numActions;
}

function imagePicker(type) { // choose images for tiles
    if (type === 'forest') {
        return 'images/grass.png';
    }
    else if (type === 'sand') {
        return 'images/desert.png';
    }
    else if (type === 'rock') {
        return 'images/rock.png';
    }
}

function randomTileType() { // choose a random tile type to assign to a tile
    var randomTile = Math.floor((Math.random() * 6) + 1);
    if (biome === 'Forest') {
        if (randomTile <= 4) {
            return 'forest';
        } else if (randomTile === 5) {
            return 'sand';
        } else if (randomTile === 6) {
            return 'rock';
        }
    } else if (biome === 'Desert') {
        if (randomTile <= 4) {
            return 'sand';
        } else if (randomTile === 5) {
            return 'rock';
        } else if (randomTile === 6) {
            return 'forest';
        }
    } else if (biome === 'Mountain') {
        if (randomTile <= 4) {
            return 'rock';
        } else if (randomTile === 5) {
            return 'forest';
        } else if (randomTile === 6) {
            return 'sand';
        }
    }
}

function isNegative(number) { // check if number is negative
    if (number > 0) {
        return true;
    } else if (number < 0) {
        return false;
    }
}

function isPlayerThereOrNah(x,y) { //  check if player is on a space
    for (var i = 0; i < players.length; i += 1) {
        if (players[i].coord.x === x && players[i].coord.y === y) {
            return true;
        }
    }
    return false;
}

function canPlayerMoveOrNah(x,y) { // check if player can move to a certain spot

    var deltaX = x - players[currentPlayer].coord.x;
    var deltaY = y - players[currentPlayer].coord.y;

    if (players[currentPlayer].coord.x + moveCounter >= x && 
        players[currentPlayer].coord.y + moveCounter >= y && 
        players[currentPlayer].coord.x - moveCounter <= x && 
        players[currentPlayer].coord.y - moveCounter <= y && 
        (Math.abs(deltaX) + Math.abs(deltaY) <= moveCounter || (isNegative(deltaX) !== isNegative(deltaY) && (Math.abs(deltaY) <= moveCounter || Math.abs(deltaX) <= moveCounter))) && 
        isPlayerThereOrNah(x,y) === false &&
        boardMain[y][x].type !== "rock") { //  player cannot move onto a rock space

        return true;

    } 

    return false;
}

function rangedAttack() {
    for (var i = players[currentPlayer].coord.x; i < size; i+=1) { // shoot to the right along x axis || RANGED
        if (boardMain[players[currentPlayer].coord.y][i].type === 'rock') {
            break;
        } else {
            boardMain[players[currentPlayer].coord.y][i].backgroundPath.visible = true;
        }
    }
    for (var i = players[currentPlayer].coord.x; i >= 0; i-=1) { // shoot to the left along x axis || RANGED
        if (boardMain[players[currentPlayer].coord.y][i].type === 'rock') {
            break;
        } else {
            boardMain[players[currentPlayer].coord.y][i].backgroundPath.visible = true;
        }
    }
    for (var i = players[currentPlayer].coord.y; i < size; i+=1) { // shoot down along y axis || RANGED
        if (boardMain[i][players[currentPlayer].coord.x].type === 'rock') {
            break;
        } else {
            boardMain[i][players[currentPlayer].coord.x].backgroundPath.visible = true;
        }
    }
    for (var i = players[currentPlayer].coord.y; i >= 0; i-=1) { // shoot to the up along y axis || RANGED
        if (boardMain[i][players[currentPlayer].coord.x].type === 'rock') {
            break;
        } else {
            boardMain[i][players[currentPlayer].coord.x].backgroundPath.visible = true;
        }
    }
    // third axis ii - players[currentPlayer].coord.x)*(-1) === i - players[currentPlayer].coord.y
}

function onFrame(event) { // runs 60 times per second TIP: Dont put a lot of loops in here because it will slow the game down a BUNCH
    if (turnCounter === 2) {

        rangedAttack();

    }
}

function onMouseMove(event) {
    for (var i = 0; i < size; i += 1) {
        for (var ii = 0; ii < size; ii += 1) {
            if (boardMain[i][ii].path.contains(event.point)) {
                //   move events here

            } 
            
        }
    }
}

function onMouseDrag(event) {
    //if statement about if it is too far dragged or not
    for (var i = 0; i < size; i += 1) {
        for (var ii = 0; ii < size; ii += 1) {//  reposition tiles for the draging of the map

            boardMain[i][ii].backgroundPath.position.x += event.delta.x/3; // drag circles that highlight usable tiles: x coord
            boardMain[i][ii].backgroundPath.position.y += event.delta.y/3; // y ccord

            boardMain[i][ii].path.position.x += event.delta.x/3; // drag the tiles: x coord
            boardMain[i][ii].path.position.y += event.delta.y/3; // y coord

        }
        if (i < players.length) { // just using the board checker to also check the players
            players[i].path.position.x += event.delta.x/3; // move players when map is being drgged
            players[i].path.position.y += event.delta.y/3;
            players[i].nameLabel.position.x += event.delta.x/3; // move the name label
            players[i].nameLabel.position.y += event.delta.y/3;
        }
    }
}

function onMouseDown(event) {
    for (var i = 0; i < size; i += 1) {
        for (var ii = 0; ii < size; ii += 1) {
            if (boardMain[i][ii].path.contains(event.point)) {
                //click events here

                boardMain[i][ii].path.bounds.width -=10; // make the tile small when click down
                boardMain[i][ii].path.bounds.height -=10;

                boardMain[i][ii].path.position.x +=5;// reposition tile to center
                boardMain[i][ii].path.position.y +=5;
                
                console.log('x: ' + ii + '  y: ' + i);
                if (move === true) {
                    //   move math here
                }
            }
        }
    }
    if (button.contains(event.point)) { // this will go when the statbar is in place with the advance button
        button.fillColor = '#2576ef';
        button.strokeColor = '#75a8f5';
    }
}

function onMouseUp(event) {

    for (var i = 0; i < size; i += 1) {
        for (var ii = 0; ii < size; ii += 1) {

            if (boardMain[i][ii].path.bounds.width < 109) {// make the tile large again

                boardMain[i][ii].path.bounds.width +=10;
                boardMain[i][ii].path.bounds.height +=10;

                boardMain[i][ii].path.position.x -=5;// reposition tile back to center
                boardMain[i][ii].path.position.y -=5;
            }

            if (boardMain[i][ii].path.contains(event.point)) {
                //   move events here
                
                

                if (turnCounter === 1) {
                    //console.log(ii + "  " + i)
                    var deltaX = ii - players[currentPlayer].coord.x;
                    var deltaY = i - players[currentPlayer].coord.y;

                    if (canPlayerMoveOrNah(ii,i)) {

                        players[currentPlayer].path.position = boardMain[i][ii].path.position;
                        players[currentPlayer].nameLabel.position = boardMain[i][ii].path.position;
                        players[currentPlayer].coord.x = ii;
                        players[currentPlayer].coord.y = i;

                        moveCounter = 0;

                    } 
                }

                if (turnCounter === 2 && boardMain[i][ii].backgroundPath.visible === true) { // this whole shabang is about attacking
                    for (var u = 0; u < players.length; u += 1) {
                        if (u !== currentPlayer) {
                            if (players[u].coord.x === ii && players[u].coord.y === i) {
                                players[u].health -= 1;
                                console.log("player " + (u+1) + " loses 1 health and is at " + players[u].health + " health");
                            }
                        }
                    }
                }
            }
            if (turnCounter === 2) {
                   //boardMain[i][ii].backgroundPath.visible = false;
            }
        }
    }

    if (button.contains(event.point)) {

        turnCounter++;

        if (turnCounter === 3) {

            for (var i = 0; i < size; i += 1) {//  clearing the circles at end of turn
                for (var ii = 0; ii < size; ii += 1) {

                    boardMain[i][ii].backgroundPath.visible = false; // reset all tiles to non movable

                }
            }

            currentPlayer++;
            if (currentPlayer === players.length) {
                currentPlayer = 0;
            }

            hideBBar();

            turnCounter = 0;
            
            numCards = players[currentPlayer].cards.length;
            actionCounter = players[currentPlayer].character.numActions;
        } else if (turnCounter === 1) {
            moveCounter = Math.floor((Math.random() * players[currentPlayer].character.dice) + 1);
        }

        if (turnCounter === 0) {
            btnText.content = 'roll';
        } else if (turnCounter === 1) {
            btnText.content = 'action';
        } else if (turnCounter === 2) {
            btnText.content = 'next turn';
        }
    }

    for (var i = 0; i < size; i += 1) {//just trying to see where i can go
        for (var ii = 0; ii < size; ii += 1) {
            //   move events here

            boardMain[i][ii].backgroundPath.visible = false; // reset all tiles to non movable, then set them to movable don there\/

            if (turnCounter === 1) { // if in the move phase
                if (canPlayerMoveOrNah(ii,i)) {// shows you where you can move on the map

                    boardMain[i][ii].backgroundPath.visible = true;//  can move here

                } 
            }
        }
    }

    button.fillColor = '#75a8f5'; // can remove this after stat bar is completed
    button.strokeColor = '#2576ef';
}


//---buttons---
var button = new Path.RegularPolygon(new Point(view.bounds.width - 100, 100), 3, 70);
button.fillColor = '#75a8f5';
button.strokeWidth = 6;
button.strokeColor = '#2576ef';

var btnText = new PointText({
    point: button.position,
    justification: 'center',
    fontSize: 30,
    fillColor: 'white',
    content: 'roll'
});



    </script>
</body>
</html>
